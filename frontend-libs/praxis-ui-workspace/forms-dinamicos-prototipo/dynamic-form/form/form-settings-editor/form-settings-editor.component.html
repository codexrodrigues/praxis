<!-- form-settings-editor/form-settings-editor.component.html -->
<div class="form-settings-editor">
  <div class="header">
    <h2>Configurações do Formulário</h2>
    <div class="actions">
      <button class="btn-save" (click)="saveSettings()" [disabled]="!isFormValid || messagesForm?.invalid">Salvar</button>
      <button class="btn-cancel" (click)="cancel()">Cancelar</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tab" [class.active]="activeTab === 'general'" (click)="setActiveTab('general')">Geral</div>
    <div class="tab" [class.active]="activeTab === 'rules'" (click)="setActiveTab('rules')">Regras</div>
    <div class="tab" [class.active]="activeTab === 'styles'" (click)="setActiveTab('styles')">Estilos</div>
    <div class="tab" [class.active]="activeTab === 'fields'" (click)="setActiveTab('fields')">Campos</div>
    <div class="tab" [class.active]="activeTab === 'actions'" (click)="setActiveTab('actions')">Ações</div>
    <div class="tab" [class.active]="activeTab === 'api'" (click)="setActiveTab('api')">API</div>
    <div class="tab" [class.active]="activeTab === 'behavior'" (click)="setActiveTab('behavior')">Comportamento</div>
    <div class="tab" [class.active]="activeTab === 'metadata'" (click)="setActiveTab('metadata')">Metadados</div>
    <div class="tab" [class.active]="activeTab === 'messages'" (click)="setActiveTab('messages')">Mensagens</div>
  </div>

  <div class="tab-content">
    <!-- Aba Configurações Gerais -->
    <div class="tab-pane" [class.active]="activeTab === 'general'">
      <form *ngIf="settingsForm" [formGroup]="settingsForm">

        <!-- Título padrão -->
        <div class="form-group">
          <label for="formTitle">Título do Formulário</label>
          <input id="formTitle" type="text" formControlName="formTitle" class="form-control">
        </div>

        <div class="form-group">
          <label for="formDescription">Descrição</label>
          <textarea id="formDescription" formControlName="formDescription" class="form-control" rows="3"></textarea>
        </div>

        <div class="form-group">
          <button kendoButton themeColor="primary" type="button" (click)="aplicarTituloParaTodos()">Aplicar para
            todos</button>
        </div>

        <!-- Títulos para formMode - create - view - edit -->
        <div class="form-group">
          <kendo-expansionpanel title="Títulos para criação, visualização e edição" subtitle="Demais títulos"
            [expanded]="false">
            <div class="form-group">
              <label for="formTitleCreate">Título do Formulário para cadastro</label>
              <input id="formTitleCreate" type="text" formControlName="formTitleCreate" class="form-control">
            </div>

            <div class="form-group">
              <label for="formDescriptionCreate">Descrição do Formulário para cadastro</label>
              <textarea id="formDescriptionCreate" formControlName="formDescriptionCreate" class="form-control"
                rows="3"></textarea>
            </div>
            <div class="form-group">
              <label for="formTitleView">Título do Formulário para visualização</label>
              <input id="formTitleView" type="text" formControlName="formTitleView" class="form-control">
            </div>

            <div class="form-group">
              <label for="formDescriptionView">Descrição do Formulário para visualização</label>
              <textarea id="formDescriptionView" formControlName="formDescriptionView" class="form-control"
                rows="3"></textarea>
            </div>

            <div class="form-group">
              <label for="formTitleEdit">Título do Formulário para edição</label>
              <input id="formTitleEdit" type="text" formControlName="formTitleEdit" class="form-control">
            </div>

            <div class="form-group">
              <label for="formDescriptionEdit">Descrição do Formulário para edição</label>
              <textarea id="formDescriptionEdit" formControlName="formDescriptionEdit" class="form-control"
                rows="3"></textarea>
            </div>
          </kendo-expansionpanel>
        </div>




        <div class="form-group">
          <label for="className">Classe CSS</label>
          <input id="className" type="text" formControlName="className" class="form-control">
        </div>

        <div class="form-row">
          <div class="form-group form-check">
            <input id="autoSave" type="checkbox" formControlName="autoSave" class="form-check-input">
            <label for="autoSave" class="form-check-label">Auto-salvar alterações</label>
          </div>

          <div class="form-group" *ngIf="settingsForm?.get('autoSave')?.value">
            <label for="autoSaveDebounce">Tempo de debounce (ms)</label>
            <input id="autoSaveDebounce" type="number" formControlName="autoSaveDebounce" class="form-control">
          </div>
        </div>

        <div class="form-group form-check">
          <input id="readOnly" type="checkbox" formControlName="readOnly" class="form-check-input">
          <label for="readOnly" class="form-check-label">Formulário somente leitura</label>
        </div>
      </form>
    </div>

    <!-- Adicionar esta nova tab-pane após as outras seções de tab-pane existentes -->
    <div class="tab-pane" [class.active]="activeTab === 'rules'">
      <div class="form-rules-section">
        <div class="section-header">
          <h3>Regras do Formulário</h3>
          <button type="button" class="btn-add" (click)="addRule()">
            Adicionar Regra
          </button>
        </div>

        <div class="rules-list">
          <div class="no-rules" *ngIf="(formLayout?.formRules ?? []).length === 0">
            Nenhuma regra definida. Clique em "Adicionar Regra" para criar uma nova.
          </div>

          <div class="rule-item" *ngFor="let rule of formLayout?.formRules">
            <div class="rule-header">
              <div class="rule-title">{{rule.name}}</div>
              <div class="rule-actions">
                <button type="button" class="btn-edit" (click)="editRule(rule)">
                  <span class="icon-edit"></span>
                </button>
                <button type="button" class="btn-remove" (click)="removeRule(rule)">
                  <span class="icon-delete"></span>
                </button>
              </div>
            </div>

            <div class="rule-content">
              <div class="rule-info">
                <div class="info-item">
                  <span class="info-label">Contexto:</span>
                  <span class="info-value">{{getContextDisplayName(rule.context)}}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Campos afetados:</span>
                  <span class="info-value">{{rule.targetFields.length || 0}} campo(s)</span>
                </div>
                <div class="info-item" *ngIf="rule.description">
                  <span class="info-label">Descrição:</span>
                  <span class="info-value">{{rule.description}}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Aba Estilos -->
    <div class="tab-pane" [class.active]="activeTab === 'styles'">
      <form *ngIf="styleForm" [formGroup]="styleForm">
        <div formGroupName="styles">
          <div class="styles-header">
            <h3>Estilos CSS</h3>
            <button type="button" class="btn-add" (click)="addStyleProperty()">
              Adicionar Propriedade
            </button>
          </div>

          <div class="style-properties">
            <div class="no-styles" *ngIf="!Object.keys(stylesValue).length">
              Nenhuma propriedade CSS definida. Clique em "Adicionar Propriedade" para incluir.
            </div>

            <div class="style-property" *ngFor="let property of Object.keys(stylesValue)">
              <div class="property-name">{{property}}</div>
              <input type="text" [formControlName]="property" class="form-control">
              <button type="button" class="btn-remove" (click)="removeStyleProperty(property)">
                <span class="icon-delete"></span>
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Aba Ações -->
    <div class="tab-pane" [class.active]="activeTab === 'actions'">
      <form *ngIf="actionsForm" [formGroup]="actionsForm">
        <div class="form-section">
          <h3>Botões Padrão</h3>

          <div class="form-group form-check">
            <input id="showSaveButton" type="checkbox" formControlName="showSaveButton" class="form-check-input">
            <label for="showSaveButton" class="form-check-label">Exibir botão de salvar</label>
          </div>

          <div class="form-group" *ngIf="actionsForm?.get('showSaveButton')?.value">
            <label for="submitButtonLabel">Texto do botão de salvar</label>
            <input id="submitButtonLabel" type="text" formControlName="submitButtonLabel" class="form-control">
          </div>

          <div class="form-group form-check">
            <input id="showCancelButton" type="checkbox" formControlName="showCancelButton" class="form-check-input">
            <label for="showCancelButton" class="form-check-label">Exibir botão de cancelar</label>
          </div>

          <div class="form-group" *ngIf="actionsForm?.get('showCancelButton')?.value">
            <label for="cancelButtonLabel">Texto do botão de cancelar</label>
            <input id="cancelButtonLabel" type="text" formControlName="cancelButtonLabel" class="form-control">
          </div>

          <div class="form-group form-check">
            <input id="showResetButton" type="checkbox" formControlName="showResetButton" class="form-check-input">
            <label for="showResetButton" class="form-check-label">Exibir botão de limpar</label>
          </div>

          <div class="form-group" *ngIf="actionsForm.get('showResetButton')?.value">
            <label for="resetButtonLabel">Texto do botão de limpar</label>
            <input id="resetButtonLabel" type="text" formControlName="resetButtonLabel" class="form-control">
          </div>
        </div>

        <div class="form-section">
          <h3>Posicionamento</h3>

          <div class="form-group">
            <label for="position">Alinhamento dos botões</label>
            <kendo-combobox [data]="buttonPositions" id="position" formControlName="position" textField="label"
              valueField="value" [valuePrimitive]="true" [clearButton]="false">
            </kendo-combobox>
          </div>

          <div class="form-group">
            <label for="containerClassName">Classe CSS do container</label>
            <input id="containerClassName" type="text" formControlName="containerClassName" class="form-control">
          </div>

          <!-- Estilos do container -->
          <div formGroupName="containerStyles">
            <div class="styles-header">
              <h3>Estilos do container de botões</h3>
              <button type="button" class="btn-add" (click)="addContainerStyleProperty()">
                Adicionar Propriedade
              </button>
            </div>

            <div class="style-properties">
              <div class="no-styles" *ngIf="!Object.keys(actionsForm?.get('containerStyles')?.value || {}).length">
                Nenhuma propriedade CSS definida para o container.
              </div>

              <div class="style-property"
                *ngFor="let property of Object.keys(actionsForm.get('containerStyles')?.value)">
                <div class="property-name">{{property}}</div>
                <input type="text" [formControlName]="property" class="form-control">
                <button type="button" class="btn-remove" (click)="removeContainerStyleProperty(property)">
                  <span class="icon-delete"></span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Aba API -->
    <div class="tab-pane" [class.active]="activeTab === 'api'">
      <form *ngIf="apiForm" [formGroup]="apiForm">
        <div class="form-group">
          <label for="saveEndpoint">Endpoint para salvar</label>
          <input id="saveEndpoint" type="text" formControlName="saveEndpoint" class="form-control">
        </div>

        <div class="form-group">
          <label for="loadEndpoint">Endpoint para carregar</label>
          <input id="loadEndpoint" type="text" formControlName="loadEndpoint" class="form-control">
        </div>

        <div class="form-group">
          <label for="saveMethod">Método HTTP</label>
          <select id="saveMethod" formControlName="saveMethod" class="form-control">
            <option *ngFor="let method of httpMethods" [value]="method">{{method}}</option>
          </select>
        </div>

        <div class="form-group">
          <label for="idField">Campo identificador (ID)</label>
          <input id="idField" type="text" formControlName="idField" class="form-control">
        </div>

        <div class="form-group">
          <label for="timeout">Timeout (ms)</label>
          <input id="timeout" type="number" formControlName="timeout" class="form-control">
        </div>

        <!-- Headers -->
        <div class="form-section">
          <div class="styles-header">
            <h3>Headers</h3>
            <button type="button" class="btn-add" (click)="addHeaderProperty()">
              Adicionar Header
            </button>
          </div>

          <div class="style-properties">
            <div class="no-styles"
              *ngIf="!formLayout?.api?.headers || !Object.keys(formLayout?.api?.headers || {}).length">
              Nenhum header definido.
            </div>

            <div class="style-property" *ngFor="let header of (formLayout?.api?.headers || {}) | keyvalue">
              <div class="property-name">{{header.key}}</div>
              <input type="text" [(ngModel)]="(formLayout?.api?.headers || {})[header.key]"
                [ngModelOptions]="{standalone: true}" class="form-control">
              <button type="button" class="btn-remove" (click)="removeHeaderProperty(header.key)">
                <span class="icon-delete"></span>
              </button>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="beforeSave">Hook antes de salvar (JavaScript)</label>
          <textarea id="beforeSave" formControlName="beforeSave" class="form-control code-editor" rows="4"></textarea>
          <small class="form-text text-muted">Função para transformar dados antes de enviar ao servidor</small>
        </div>

        <div class="form-group">
          <label for="afterLoad">Hook após carregar (JavaScript)</label>
          <textarea id="afterLoad" formControlName="afterLoad" class="form-control code-editor" rows="4"></textarea>
          <small class="form-text text-muted">Função para processar dados após recebê-los do servidor</small>
        </div>
      </form>
    </div>

    <!-- Aba Comportamento -->
    <div class="tab-pane" [class.active]="activeTab === 'behavior'">
      <form *ngIf="behaviorForm" [formGroup]="behaviorForm">
        <div class="form-group form-check">
          <input id="confirmOnUnsavedChanges" type="checkbox" formControlName="confirmOnUnsavedChanges"
            class="form-check-input">
          <label for="confirmOnUnsavedChanges" class="form-check-label">
            Confirmar antes de sair com alterações não salvas
          </label>
        </div>

        <div class="form-group form-check">
          <input id="trackHistory" type="checkbox" formControlName="trackHistory" class="form-check-input">
          <label for="trackHistory" class="form-check-label">
            Manter histórico de alterações (undo/redo)
          </label>
        </div>

        <div class="form-group form-check">
          <input id="focusFirstError" type="checkbox" formControlName="focusFirstError" class="form-check-input">
          <label for="focusFirstError" class="form-check-label">
            Focar no primeiro campo com erro após validação
          </label>
        </div>

        <div class="form-group form-check">
          <input id="scrollToErrors" type="checkbox" formControlName="scrollToErrors" class="form-check-input">
          <label for="scrollToErrors" class="form-check-label">
            Rolar automaticamente para campos com erro
          </label>
        </div>

        <div class="form-group form-check">
          <input id="clearAfterSave" type="checkbox" formControlName="clearAfterSave" class="form-check-input">
          <label for="clearAfterSave" class="form-check-label">
            Limpar formulário após salvar com sucesso
          </label>
        </div>

        <div class="form-group">
          <label for="redirectAfterSave">Redirecionar após salvar (URL ou rota)</label>
          <input id="redirectAfterSave" type="text" formControlName="redirectAfterSave" class="form-control">
        </div>
      </form>
    </div>

    <!-- Aba Metadados -->
    <div class="tab-pane" [class.active]="activeTab === 'metadata'">
      <form *ngIf="metadataForm" [formGroup]="metadataForm">
        <div class="form-group">
          <label for="formCode">Código do Formulário</label>
          <input id="formCode" type="text" formControlName="formCode" class="form-control">
        </div>

        <div class="form-group">
          <label for="version">Versão</label>
          <input id="version" type="text" formControlName="version" class="form-control">
        </div>

        <!-- Metadados personalizados -->
        <div class="form-section">
          <div class="styles-header">
            <h3>Metadados Personalizados</h3>
            <button type="button" class="btn-add" (click)="addMetadataProperty()">
              Adicionar Metadado
            </button>
          </div>

          <div class="metadata-properties">
            <div class="no-metadata"
              *ngIf="!formLayout?.metadata || Object.keys(formLayout?.metadata || {}).length <= 2">
              Nenhum metadado personalizado definido.
            </div>

            <div class="metadata-property" *ngFor="let meta of (formLayout?.metadata || {}) | keyvalue">
              <ng-container *ngIf="meta.key !== 'formCode' && meta.key !== 'version'">
                <div class="property-name">{{meta.key}}</div>
                <input type="text" [(ngModel)]="(formLayout?.metadata || {})[meta.key]"
                  [ngModelOptions]="{standalone: true}" class="form-control">
                <button type="button" class="btn-remove" (click)="removeMetadataProperty(meta.key)">
                  <span class="icon-delete"></span>
                </button>
              </ng-container>
            </div>
          </div>
        </div>
      </form>
    </div>


    <!-- Aba de Mensagens -->
    <div class="tab-pane" [class.active]="activeTab === 'messages'">
      <form *ngIf="messagesForm" [formGroup]="messagesForm">
        <div class="form-group">
          <label for="createRegistrySucess">Registro criado com sucesso</label>
          <input id="createRegistrySucess" type="text" formControlName="createRegistrySuccess" class="form-control">
          <kendo-formerror *ngIf="messagesForm.get('createRegistrySuccess')?.invalid">
            <span *ngIf="messagesForm.get('createRegistrySuccess')?.errors?.['required']">Campo obrigatório.</span>
          </kendo-formerror>
        </div>
        <div class="form-group">
          <label for="updateRegistrySucess">Registro atualizado com sucesso</label>
          <input id="updateRegistrySucess" type="text" formControlName="updateRegistrySuccess" class="form-control">
          <kendo-formerror *ngIf="messagesForm.get('updateRegistrySuccess')?.invalid">
            <span *ngIf="messagesForm.get('updateRegistrySuccess')?.errors?.['required']">Campo obrigatório.</span>
          </kendo-formerror>
        </div>

        <div class="form-group">
          <label for="createRegistryError">Erro ao criar registro</label>
          <input id="createRegistryError" type="text" formControlName="createRegistryError" class="form-control">
          <kendo-formerror *ngIf="messagesForm.get('createRegistryError')?.invalid">
            <span *ngIf="messagesForm.get('createRegistryError')?.errors?.['required']">Campo obrigatório.</span>
          </kendo-formerror>
        </div>
        <div class="form-group">
          <label for="updateRegistryError">Erro ao atualizar registro</label>
          <input id="updateRegistryError" type="text" formControlName="updateRegistryError" class="form-control">
          <kendo-formerror *ngIf="messagesForm.get('updateRegistryError')?.invalid">
            <span *ngIf="messagesForm.get('updateRegistryError')?.errors?.['required']">Campo obrigatório.</span>
          </kendo-formerror>
        </div>
      </form>
    </div>


    <!-- Aba Campos -->
    <div class="tab-pane" [class.active]="activeTab === 'fields'">
      <th-dynamic-field-detail [fieldsets]="formLayout?.fieldsets" (fieldsetsChange)="atualizaFieldsets($event)"></th-dynamic-field-detail>
    </div>
  </div>
</div>
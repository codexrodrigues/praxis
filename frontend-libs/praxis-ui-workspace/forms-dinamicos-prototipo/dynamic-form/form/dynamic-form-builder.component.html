<!--lib-angular-ui\src\app\funcionalidades\form-field-drag\form-field-drag.component.html-->
<kendo-card class="my-card">
  <!-- Cabeçalho do Card -->
  <kendo-card-header>
    <div class="card-header-content">
      <div class="header-text">
        <h3 kendoCardTitle>
          {{
          formMode === 'create' && formLayout.formTitleCreate ? formLayout.formTitleCreate :
          formMode === 'edit' && formLayout.formTitleEdit ? formLayout.formTitleEdit :
          formMode === 'view' && formLayout.formTitleView ? formLayout.formTitleView :
          formLayout.formTitle
          }}
        </h3>


        <p kendoCardSubtitle>
          {{
          formMode === 'create' && formLayout.formDescriptionCreate ? formLayout.formDescriptionCreate :
          formMode === 'edit' && formLayout.formDescriptionEdit ? formLayout.formDescriptionEdit :
          formMode === 'view' && formLayout.formDescriptionView ? formLayout.formDescriptionView :
          formLayout.formDescription
          }}
        </p>
      </div>

      <!-- Barra de botões de ação -->
      <div class="header-action-buttons">
        @if (showBackButton && shouldShowBackButton) {
        <button kendoButton (click)="handleBackToPrevious()" fillMode="outline" iconClass="bi bi-arrow-left"
          themeColor="secondary">Voltar</button>
        }

        <!-- Configurações do Formulário -->
        <button *ngIf="editMode" class="header-icon-button" (click)="openFormSettings()"
          title="Configurações do Formulário">
          <i class="bi bi-sliders"></i>
        </button>

        <!-- Histórico de modificações -->
        <button *ngIf="editMode" class="header-icon-button" (click)="openModificationHistory()"
          title="Histórico de modificações">
          <i class="bi bi-clock-history"></i>
        </button>

        <!-- Conexão No-Code com Ações -->
        <button *ngIf="editMode" class="header-icon-button" (click)="openActionsConfiguration()"
          title="Configurar ações">
          <i class="bi bi-diagram-3"></i>
        </button>

        <!-- Editar JSON -->
        <button *ngIf="editMode" class="header-icon-button" (click)="openJsonEditor()" title="Editar JSON">
          <i class="bi bi-code-square"></i>
        </button>
      </div>
    </div>
  </kendo-card-header>

  <!-- Corpo do Card -->
  <kendo-card-body>
    <div *ngIf="isLoading">
      <kendo-skeleton shape="text" animation="pulse" width="100%"></kendo-skeleton>
      <kendo-skeleton shape="text" animation="pulse" width="60%"></kendo-skeleton>
      <kendo-skeleton style="margin-top: 30px;" shape="rectangle" animation="pulse" width="100%"
        height="103.86px"></kendo-skeleton>
      <kendo-skeleton style="margin-top: 30px;" shape="text" animation="pulse" width="100%"></kendo-skeleton>
    </div>

    <form *ngIf="formGroup && Object.keys(formGroup.controls).length" [formGroup]="formGroup">
      <!-- Lista de Fieldsets (drop list de nível superior) -->
      <div (cdkDropListDropped)="dropFieldset($event)"
        [cdkDropListConnectedTo]="formLayoutService.getConnectedDropLists(formLayout.fieldsets)"
        [cdkDropListData]="formLayout.fieldsets" [cdkDropListDisabled]="!editMode"
        [cdkDropListEnterPredicate]="topLevelEnterPredicate" cdkDropList cdkDropListOrientation="vertical"
        class="fieldset-list top-level-drop-list" id="topLevel">

        <div *ngFor="let fieldset of formLayout.fieldsets; trackBy: trackByFieldset"
          [cdkDragData]="{ type: 'fieldset', data: fieldset }" [cdkDragDisabled]="!editMode"
          [ngClass]="{'edit-mode': editMode}" cdkDrag
          [style.display]="hiddenFieldsetsMap.get(fieldset.id) ? 'none' : ''" class="fieldset">

          <fieldset-header [ngClass]="{'edit-mode': editMode}"
            (orientationChanged)="onFieldsetOrientationChanged($event)" (addFieldset)="handleAddFieldset()"
            (removeFieldset)="handleRemoveFieldset($event)" (addRow)="handleAddRow($event)" [editMode]="editMode"
            [fieldset]="fieldset" [formMode]="formMode"></fieldset-header>

          <!-- Preview e Placeholder para o Fieldset -->
          <ng-template cdkDragPreview>
            <div class="drag-preview">
              <strong>{{ fieldset.title }}</strong>
            </div>
          </ng-template>
          <ng-template cdkDragPlaceholder>
            <div class="drag-placeholder">
              <strong>{{ fieldset.title }}</strong>
            </div>
          </ng-template>

          <!-- Lista de Rows/Colunas dentro do Fieldset -->
          <div (cdkDropListDropped)="dropRow($event, fieldset)"
            [cdkDropListConnectedTo]="formLayoutService.getConnectedDropLists(formLayout.fieldsets)"
            [cdkDropListData]="fieldset.rows" [cdkDropListDisabled]="!editMode"
            [cdkDropListEnterPredicate]="nestedEnterPredicate.bind(this)"
            [cdkDropListOrientation]="fieldset.orientation === 'horizontal' ? 'horizontal' : 'vertical'"
            [ngClass]="{'edit-mode': editMode}"
            [ngStyle]="{'flex-direction': fieldset.orientation === 'horizontal' ? 'row' : 'column'}" cdkDropList
            class="row-list" id="fieldset_{{fieldset.id}}">

            <row [ngClass]="{'edit-mode': editMode}" (addRow)="handleAddRow($event)" style="width: 100%;"
              [style.display]="hiddenRowsMap.get(row.id) ? 'none' : ''"
              (fieldDropped)="dropField($event, fieldset, row)" (removeRow)="handleRemoveRow($event)"
              (toggleRowOrientation)="toggleRowOrientation($event)"
              (fieldRemoved)="handleFieldRemove($event, fieldset.id)"
              *ngFor="let row of fieldset.rows; let rowIndex = index" [cdkDragData]="{ type: 'row', data: row }"
              [cdkDragDisabled]="!editMode"
              [connectedItemsDropLists]="formLayoutService.getConnectedItemsDropLists(formLayout.fieldsets)"
              [editMode]="editMode" [fieldset]="fieldset" [formGroup]="formGroup" [rowIndex]="rowIndex" [row]="row"
              cdkDrag>
            </row>

          </div>

        </div>


      </div>

    </form>
  </kendo-card-body>

  <!-- Rodapé do Card: Utilizando o componente de ações -->
  <dynamic-form-buttons-actions (cancelAction)="handleCancel()" (resetAction)="handleReset()" [formMode]="formMode"
    (submitAction)="handleSubmit()" [actions]="formLayout.actions" [form]="formGroup">
  </dynamic-form-buttons-actions>

</kendo-card>

<kendo-window (close)="closeJsonEditor()" *ngIf="showJsonEditor" [height]="600" [width]="800"
  title="Estrutura do Formulário em formato JSON">
  <div class="json-editor-content">
    <textarea [(ngModel)]="jsonEditorText" spellcheck="false"
      style="width: 100%; height: 80%; font-family: monospace; font-size: 14px; "></textarea>
  </div>
  <div class="json-editor-actions" style="text-align: right; margin-top: 12px;">
    <button (click)="saveJsonEditorChanges()">Salvar</button>
    <button (click)="closeJsonEditor()">Cancelar</button>
  </div>
</kendo-window>
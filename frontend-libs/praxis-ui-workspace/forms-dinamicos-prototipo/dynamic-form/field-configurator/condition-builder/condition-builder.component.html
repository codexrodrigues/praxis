<div class="condition-builder elegant-component">
  <ng-container *ngIf="conditions.length > 1">
    <div class="logic-selector">
      <kendo-buttongroup selection="single">
        <button
          kendoButton
          [toggleable]="true"
          [selected]="logicOperator === 'and'"
          (click)="onLogicChange('and')"
          themeColor="primary"
          [fillMode]="logicOperator === 'and' ? 'solid' : 'outline'"
          title="Exige que TODAS as condições sejam satisfeitas"
        >
          Todas as condições (E)
        </button>
        <button
          kendoButton
          [toggleable]="true"
          [selected]="logicOperator === 'or'"
          (click)="onLogicChange('or')"
          themeColor="primary"
          [fillMode]="logicOperator === 'or' ? 'solid' : 'outline'"
          title="Exige que PELO MENOS UMA condição seja satisfeita"
        >
          Qualquer condição (OU)
        </button>
      </kendo-buttongroup>
    </div>
  </ng-container>

  <ng-container *ngIf="conditions.length === 0">
    <div class="empty-state elegant-empty-state">
      <i class="bi bi-card-list empty-icon"></i>
      <strong>Nenhuma condição definida.</strong><br />
      Clique em <i>+ Adicionar Condição</i> para criar a primeira regra.
    </div>
  </ng-container>

  <div class="conditions-list">
    <div
      class="condition-item-wrapper"
      *ngFor="let condition of conditions; let i = index; trackBy: trackById"
    >
      <div class="condition-item elegant-condition-item">
        <div class="condition-field">
          <kendo-dropdownlist
            [data]="availableFields"
            textField="label"
            valueField="name"
            [value]="condition.field"
            (valueChange)="onFieldChange(i, $event)"
            [valuePrimitive]="true"
            fillMode="outline"
            title="Selecione qual campo deseja avaliar"
          >
          </kendo-dropdownlist>
        </div>
        <div class="condition-type">
          <kendo-dropdownlist
            [data]="getFieldTypeOptions(condition.field)"
            textField="text"
            valueField="value"
            [value]="condition.fieldType || 'text'"
            (valueChange)="onFieldTypeChange(i, $event)"
            [valuePrimitive]="true"
            fillMode="outline"
            title="Selecione o tipo do campo para conversão"
          >
          </kendo-dropdownlist>
          <span style="font-size: 10px; color: #888">
            Tipo atual:
            {{
              getFieldTypeText(
                getSelectedFieldType(condition.field ?? "text") || "text"
              )
            }}
          </span>
        </div>

        <div class="condition-operator" *ngIf="condition.field">
          <kendo-dropdownlist
            [data]="getOperatorsForField(condition.fieldType)"
            textField="text"
            valueField="value"
            [value]="condition.operator"
            (valueChange)="onOperatorChange(i, $event)"
            [valuePrimitive]="true"
            fillMode="outline"
            title="Escolha como o campo será comparado"
          >
            <ng-template kendoDropDownListNoDataTemplate>
              (Sem opções)
            </ng-template>
          </kendo-dropdownlist>
        </div>
        <div
          class="condition-operator-placeholder"
          *ngIf="!condition.field"
        ></div>

        <div
          class="condition-value"
          *ngIf="
            condition.field &&
            condition.operator &&
            requiresValue(condition.operator)
          "
        >
          <ng-container
            *ngIf="hasFieldOptions(condition.field); else customInput"
          >
            <kendo-dropdownlist
              [data]="getFieldOptions(condition.field)"
              textField="displayField"
              valueField="valueField"
              [value]="condition.value"
              (valueChange)="onValueChange(i, $event)"
              [valuePrimitive]="true"
              fillMode="outline"
              [filterable]="true"
              title="Selecione o valor para comparar"
            >
            </kendo-dropdownlist>
          </ng-container>
          <ng-template #customInput>
            <kendo-textbox
              *ngIf="condition.fieldType === 'text'"
              [value]="condition.value"
              (valueChange)="onValueChange(i, $event)"
              placeholder="Digite o texto..."
              fillMode="outline"
              title="Digite o texto para comparar"
            >
            </kendo-textbox>

            <kendo-numerictextbox
              *ngIf="condition.fieldType === 'number'"
              [value]="condition.value"
              format="n"
              (valueChange)="onValueChange(i, $event)"
              placeholder="Digite o número..."
              fillMode="outline"
              title="Digite o número para comparar"
            >
            </kendo-numerictextbox>

            <kendo-datepicker
              *ngIf="condition.fieldType === 'date'"
              [incompleteDateValidation]="true"
              [(ngModel)]="condition.value"
              #dateModel="ngModel"
              [fillMode]="'outline'"
              (valueChange)="onValueChange(i, datepicker.value)"
              #datepicker
            >
              <kendo-datepicker-messages
                [clearTitle]="'Limpar data'"
                [today]="'Hoje'"
              >
              </kendo-datepicker-messages>
            </kendo-datepicker>

            <kendo-datetimepicker
              *ngIf="condition.fieldType === 'date-time'"
              [fillMode]="'outline'"
              #dateTimeModel="ngModel"
              [(ngModel)]="condition.value"
              (valueChange)="onValueChange(i, dateTime.value)"
              #dateTime
            >
              <kendo-datetimepicker-messages
                [clearTitle]="'Limpar data e hora'"
                [today]="'Hoje'"
                [hour]="'Hora'"
                [minute]="'Minuto'"
                [second]="'Segundo'"
                [cancel]="'Cancelar'"
                [dateTab]="'Data'"
                [timeTab]="'Hora'"
                [accept]="'Confirmar'"
                [cancel]="'Cancelar'"
              >
              </kendo-datetimepicker-messages>
            </kendo-datetimepicker>

            <div
              *ngIf="condition.fieldType === 'boolean'"
              class="boolean-input"
            >
              <label>
                <kendo-radiobutton
                  type="radio"
                  [checked]="condition.value === true"
                  (change)="onValueChange(i, true)"
                />
                Sim
              </label>
              <label>
                <kendo-radiobutton
                  type="radio"
                  [checked]="condition.value === false"
                  (change)="onValueChange(i, false)"
                />
                Não
              </label>
            </div>

            <span
              class="input-type-fallback"
              *ngIf="
                !['text', 'number', 'date', 'date-time', 'boolean'].includes(
                  condition.fieldType || ''
                )
              "
            >
              (Entrada não disponível para tipo {{ condition.fieldType }})
            </span>
          </ng-template>
        </div>
        <div
          class="condition-value-placeholder"
          *ngIf="
            !condition.field ||
            !condition.operator ||
            !requiresValue(condition.operator)
          "
        ></div>

        <!-- Botão de Remover -->
        <div class="condition-remove">
          <button
            kendoButton
            icon="trash"
            title="Remover esta condição"
            fillMode="flat"
            themeColor="base"
            (click)="removeCondition(i)"
          ></button>
        </div>
      </div>

      <div
        class="condition-summary elegant-summary"
        *ngIf="condition.field && condition.operator"
      >
        <div [innerHTML]="getConditionSummary(condition)"></div>
      </div>
    </div>
  </div>

  <div class="add-condition">
    <button
      kendoButton
      icon="plus"
      (click)="addCondition()"
      title="Adicionar uma nova condição"
      themeColor="primary"
      fillMode="outline"
    >
      Adicionar Condição
    </button>
  </div>
</div>

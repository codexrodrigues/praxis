<!-- Container principal do datepicker -->
<div class="pdx-datepicker-container" [class]="datepickerSpecificClasses()">

  <!-- Presets corporativos (se habilitado e range mode) -->
  @if (isRangeMode() && rangePresets().length > 0 && presetDisplayStyle() === 'buttons') {
    <div class="pdx-date-presets">
      <div class="pdx-preset-buttons">
        @for (preset of rangePresets(); track preset.id) {
          <button
            mat-button
            type="button"
            class="pdx-preset-button"
            [class.pdx-preset-active]="activePreset() === preset.id"
            [matTooltip]="preset.description || preset.label"
            (click)="applyPreset(preset.id)">
            @if (preset.icon) {
              <mat-icon>{{ preset.icon }}</mat-icon>
            }
            {{ preset.label }}
          </button>
        }
        @if (activePreset()) {
          <button
            mat-icon-button
            type="button"
            class="pdx-preset-clear"
            matTooltip="Limpar preset"
            (click)="clearPreset()">
            <mat-icon>clear</mat-icon>
          </button>
        }
      </div>
    </div>
  }

  <!-- SINGLE DATE MODE -->
  @if (!isRangeMode()) {
    <!-- Form field para data única -->
    <mat-form-field 
      [appearance]="materialAppearance()"
      [color]="materialColor()"
      [floatLabel]="floatLabelBehavior()"
      [subscriptSizing]="metadata()?.materialDesign?.subscriptSizing || 'fixed'"
      [hideRequiredMarker]="metadata()?.materialDesign?.hideRequiredMarker || false"
      class="pdx-datepicker-field">

      <!-- Label editável ou estático -->
      @if (!labelEditingState().isEditing) {
        <mat-label 
          (dblclick)="onLabelDoubleClick()"
          [matTooltip]="metadata()?.description || ''"
          [matTooltipDisabled]="!metadata()?.description"
          matTooltipPosition="above">
          {{ metadata()?.label }}
          @if (metadata()?.required && !metadata()?.materialDesign?.hideRequiredMarker) {
            <span class="pdx-required-marker" aria-label="required"> *</span>
          }
        </mat-label>
      } @else {
        <!-- Editor inline de label -->
        <input
          #labelEditor
          matInput
          class="pdx-label-editor"
          [value]="editingLabel()"
          (input)="updateLabelText($event)"
          (blur)="onLabelEditorBlur()"
          (keydown)="onLabelEditorKeyDown($event)"
          [attr.aria-label]="'Editing label for ' + metadata()?.name">
      }

      <!-- Ícone de prefixo -->
      @if (metadata()?.prefixIcon) {
        <mat-icon 
          matPrefix 
          [matTooltip]="'Icon: ' + metadata()?.prefixIcon"
          matTooltipPosition="above">
          {{ metadata()?.prefixIcon }}
        </mat-icon>
      }

      <!-- Input do datepicker único -->
      <input
        matInput
        [matDatepicker]="picker"
        [formControl]="formControl"
        [placeholder]="inputPlaceholder()"
        [min]="minDate()"
        [max]="maxDate()"
        [matDatepickerFilter]="isDateDisabled"
        [readonly]="metadata()?.readOnly || false"
        [attr.aria-describedby]="metadata()?.hint ? componentId() + '-hint' : null"
        (dateInput)="onDateInput($event)"
        (dateChange)="onDateChange($event.value)"
        class="pdx-datepicker-input">

      <!-- Ícone de sufixo - toggle do picker único -->
      <mat-datepicker-toggle 
        matSuffix 
        [for]="picker"
        [disabled]="componentState().disabled">
        <!-- Ícone customizado se especificado -->
        @if (metadata()?.suffixIcon) {
          <mat-icon matDatepickerToggleIcon>{{ metadata()?.suffixIcon }}</mat-icon>
        }
      </mat-datepicker-toggle>

      <!-- Botão de limpar (se habilitado) -->
      @if (shouldShowClearButton() && selectedDate()) {
        <button
          mat-icon-button
          matSuffix
          type="button"
          class="pdx-clear-button"
          [attr.aria-label]="'Clear ' + metadata()?.label + ' field'"
          [matTooltip]="'Clear date'"
          matTooltipPosition="above"
          (click)="clearDate()">
          <mat-icon>clear</mat-icon>
        </button>
      }

      <!-- Texto de ajuda -->
      @if (metadata()?.hint) {
        <mat-hint 
          [id]="componentId() + '-hint'"
          align="start">
          {{ metadata()?.hint }}
        </mat-hint>
      }

      <!-- Formato de data como hint -->
      @if (!metadata()?.hint && dateFormat()) {
        <mat-hint align="end">
          Format: {{ dateFormat() }}
        </mat-hint>
      }

      <!-- Mensagens de erro -->
      @if (hasValidationError()) {
        <mat-error 
          [id]="componentId() + '-error'"
          class="pdx-error-message">
          <mat-icon class="pdx-error-icon">error_outline</mat-icon>
          {{ primaryErrorMessage() }}
        </mat-error>
      }

      <!-- Erros adicionais (se houver múltiplos) -->
      @if (allErrorMessages().length > 1) {
        <div class="pdx-additional-errors">
          @for (error of allErrorMessages().slice(1); track error) {
            <mat-error class="pdx-error-message pdx-additional-error">
              {{ error }}
            </mat-error>
          }
        </div>
      }

    </mat-form-field>

    <!-- Datepicker único -->
    <mat-datepicker 
      #picker
      [color]="materialColor()"
      [touchUi]="shouldUseTouchUi()"
      [startView]="startView()"
      [disabled]="componentState().disabled"
      (opened)="onPickerOpened()"
      (closed)="onPickerClosed()">
    </mat-datepicker>

  } @else {
    <!-- DATE RANGE MODE -->
    
    <!-- Form field para range de datas -->
    <mat-form-field 
      [appearance]="materialAppearance()"
      [color]="materialColor()"
      [floatLabel]="floatLabelBehavior()"
      [subscriptSizing]="metadata()?.materialDesign?.subscriptSizing || 'fixed'"
      [hideRequiredMarker]="metadata()?.materialDesign?.hideRequiredMarker || false"
      class="pdx-datepicker-field pdx-daterange-field">

      <!-- Label editável ou estático -->
      @if (!labelEditingState().isEditing) {
        <mat-label 
          (dblclick)="onLabelDoubleClick()"
          [matTooltip]="metadata()?.description || ''"
          [matTooltipDisabled]="!metadata()?.description"
          matTooltipPosition="above">
          {{ metadata()?.label }}
          @if (metadata()?.required && !metadata()?.materialDesign?.hideRequiredMarker) {
            <span class="pdx-required-marker" aria-label="required"> *</span>
          }
        </mat-label>
      } @else {
        <!-- Editor inline de label -->
        <input
          #labelEditor
          matInput
          class="pdx-label-editor"
          [value]="editingLabel()"
          (input)="updateLabelText($event)"
          (blur)="onLabelEditorBlur()"
          (keydown)="onLabelEditorKeyDown($event)"
          [attr.aria-label]="'Editing label for ' + metadata()?.name">
      }

      <!-- Ícone de prefixo -->
      @if (metadata()?.prefixIcon) {
        <mat-icon 
          matPrefix 
          [matTooltip]="'Icon: ' + metadata()?.prefixIcon"
          matTooltipPosition="above">
          {{ metadata()?.prefixIcon }}
        </mat-icon>
      }

      <!-- Container do date range input -->
      <mat-date-range-input 
        [rangePicker]="rangePicker"
        [formGroup]="rangeFormGroup()"
        [min]="minDate()"
        [max]="maxDate()"
        [dateFilter]="isDateDisabled"
        [disabled]="componentState().disabled"
        class="pdx-daterange-input">
        
        <!-- Input data inicial -->
        <input 
          matStartDate 
          formControlName="start"
          [placeholder]="startDatePlaceholder()"
          [readonly]="metadata()?.readOnly || false"
          (dateInput)="onRangeStartDateChange($event.value)"
          class="pdx-daterange-start">
        
        <!-- Input data final -->
        <input 
          matEndDate 
          formControlName="end"
          [placeholder]="endDatePlaceholder()"
          [readonly]="metadata()?.readOnly || false"
          (dateInput)="onRangeEndDateChange($event.value)"
          class="pdx-daterange-end">
      </mat-date-range-input>

      <!-- Toggle do range picker -->
      <mat-datepicker-toggle 
        matSuffix 
        [for]="rangePicker"
        [disabled]="componentState().disabled">
        <!-- Ícone customizado se especificado -->
        @if (metadata()?.suffixIcon) {
          <mat-icon matDatepickerToggleIcon>{{ metadata()?.suffixIcon }}</mat-icon>
        }
      </mat-datepicker-toggle>

      <!-- Botão de limpar range (se habilitado) -->
      @if (shouldShowClearButton() && selectedRange()?.startDate) {
        <button
          mat-icon-button
          matSuffix
          type="button"
          class="pdx-clear-button"
          [attr.aria-label]="'Clear ' + metadata()?.label + ' range'"
          [matTooltip]="'Clear date range'"
          matTooltipPosition="above"
          (click)="clearDateRange()">
          <mat-icon>clear</mat-icon>
        </button>
      }

      <!-- Chip do preset ativo -->
      @if (activePresetInfo()) {
        <mat-chip-set matSuffix class="pdx-active-preset-chip">
          <mat-chip
            [removable]="true"
            (removed)="clearPreset()"
            class="pdx-preset-chip">
            @if (activePresetInfo()?.icon) {
              <mat-icon matChipAvatar>{{ activePresetInfo()!.icon }}</mat-icon>
            }
            {{ activePresetInfo()?.label }}
            <mat-icon matChipRemove>cancel</mat-icon>
          </mat-chip>
        </mat-chip-set>
      }

      <!-- Texto de ajuda -->
      @if (metadata()?.hint) {
        <mat-hint 
          [id]="componentId() + '-hint'"
          align="start">
          {{ metadata()?.hint }}
        </mat-hint>
      }

      <!-- Range info como hint -->
      @if (!metadata()?.hint && selectedRange()?.startDate && selectedRange()?.endDate) {
        <mat-hint align="end">
          {{ selectedRange()!.startDate | date:dateFormat() }} - {{ selectedRange()!.endDate | date:dateFormat() }}
        </mat-hint>
      }

      <!-- Mensagens de erro para range -->
      @if (hasValidationError() || rangeFormGroup().invalid) {
        <mat-error 
          [id]="componentId() + '-error'"
          class="pdx-error-message">
          <mat-icon class="pdx-error-icon">error_outline</mat-icon>
          @if (rangeFormGroup().errors?.['rangeInvalid']) {
            {{ rangeFormGroup().errors!['rangeInvalid'][0] }}
          } @else {
            {{ primaryErrorMessage() }}
          }
        </mat-error>
      }

      <!-- Erros adicionais de range -->
      @if (rangeFormGroup().errors?.['rangeInvalid'] && rangeFormGroup().errors!['rangeInvalid'].length > 1) {
        <div class="pdx-additional-errors">
          @for (error of rangeFormGroup().errors!['rangeInvalid'].slice(1); track error) {
            <mat-error class="pdx-error-message pdx-additional-error">
              {{ error }}
            </mat-error>
          }
        </div>
      }

    </mat-form-field>

    <!-- Range Picker -->
    <mat-date-range-picker 
      #rangePicker
      [color]="materialColor()"
      [touchUi]="shouldUseTouchUi()"
      [startView]="startView()"
      [disabled]="componentState().disabled"
      (opened)="onRangePickerOpened()"
      (closed)="onRangePickerClosed()">
    </mat-date-range-picker>

  }

</div>

<!-- Loading indicator para validação assíncrona -->
@if (validationState().isValidating) {
  <div class="pdx-validation-loading" [attr.aria-label]="'Validating ' + metadata()?.label">
    <mat-icon class="pdx-loading-spinner">hourglass_empty</mat-icon>
    <span class="pdx-sr-only">Validating...</span>
  </div>
}

<!-- Presets dropdown (se configurado como dropdown) -->
@if (isRangeMode() && rangePresets().length > 0 && presetDisplayStyle() === 'dropdown') {
  <div class="pdx-date-presets-dropdown">
    <mat-form-field appearance="outline" class="pdx-preset-selector">
      <mat-label>Períodos Pré-definidos</mat-label>
      <mat-select 
        [value]="activePreset()"
        (selectionChange)="applyPreset($event.value)"
        placeholder="Selecione um período">
        <mat-option value="" (click)="clearPreset()">Personalizado</mat-option>
        @for (preset of rangePresets(); track preset.id) {
          <mat-option [value]="preset.id">
            @if (preset.icon) {
              <mat-icon>{{ preset.icon }}</mat-icon>
            }
            {{ preset.label }}
          </mat-option>
        }
      </mat-select>
    </mat-form-field>
  </div>
}

<!-- Indicador de estado enterprise (debug) -->
@if (isDebugMode() && metadata()?.security) {
  <div class="pdx-debug-info">
    <small class="pdx-debug-security">
      Security Level: {{ metadata()?.security?.securityLevel }}
      @if (metadata()?.security?.audit?.enabled) {
        | Audit: ON
      }
      @if (isRangeMode()) {
        | Range: {{ selectedRange()?.startDate | date:dateFormat() }} - {{ selectedRange()?.endDate | date:dateFormat() }}
        @if (activePreset()) {
          | Preset: {{ activePreset() }}
        }
      } @else {
        | Date: {{ selectedDate() | date:dateFormat() }}
      }
    </small>
  </div>
}
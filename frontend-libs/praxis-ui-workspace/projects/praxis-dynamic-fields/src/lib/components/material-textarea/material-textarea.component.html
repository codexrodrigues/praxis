<!-- Container principal do textarea -->
<div class="pdx-textarea-container">

  <!-- Form field principal -->
  <mat-form-field 
    [appearance]="materialAppearance()"
    [color]="materialColor()"
    [floatLabel]="floatLabelBehavior()"
    [subscriptSizing]="metadata()?.materialDesign?.subscriptSizing || 'fixed'"
    [hideRequiredMarker]="metadata()?.materialDesign?.hideRequiredMarker || false"
    [class]="textareaSpecificClasses()"
>

    <!-- Label editável ou estático -->
    @if (!labelEditingState().isEditing) {
      <mat-label 
        (dblclick)="onLabelDoubleClick()"
        [matTooltip]="metadata()?.description || ''"
        [matTooltipDisabled]="!metadata()?.description"
        matTooltipPosition="above">
        {{ metadata()?.label }}
        @if (metadata()?.required && !metadata()?.materialDesign?.hideRequiredMarker) {
          <span class="pdx-required-marker" aria-label="required"> *</span>
        }
      </mat-label>
    } @else {
      <!-- Editor inline de label -->
      <input
        #labelEditor
        matInput
        class="pdx-label-editor"
        [value]="editingLabel()"
        (input)="updateLabelText($event)"
        (blur)="onLabelEditorBlur()"
        (keydown)="onLabelEditorKeyDown($event)"
        [attr.aria-label]="'Editing label for ' + metadata()?.name">
    }

    <!-- Ícone de prefixo -->
    @if (metadata()?.prefixIcon) {
      <mat-icon 
        matPrefix 
        [matTooltip]="'Icon: ' + metadata()?.prefixIcon"
        matTooltipPosition="above">
        {{ metadata()?.prefixIcon }}
      </mat-icon>
    }

    <!-- Textarea principal -->
    <textarea
      #textareaElement
      matInput
      [formControl]="formControl"
      [placeholder]="metadata()?.placeholder || ''"
      [maxlength]="metadata()?.maxLength || null"
      [minlength]="metadata()?.minLength || null"
      [readonly]="metadata()?.readonly || metadata()?.readOnly || false"
      [spellcheck]="metadata()?.spellcheck ?? true"
      [rows]="metadata()?.rows || 4"
      [cols]="metadata()?.cols || null"
      [wrap]="metadata()?.wrap || 'soft'"
      [cdkTextareaAutosize]="shouldAutoResize()"
      [cdkAutosizeMinRows]="metadata()?.minRows || 4"
      [cdkAutosizeMaxRows]="metadata()?.maxRows || 12"
      [style.resize]="metadata()?.resize || 'vertical'"
      [attr.aria-describedby]="metadata()?.hint ? componentId() + '-hint' : null"
      (input)="onTextareaInput($event)"
      (focus)="onTextareaFocus($event)"
      (blur)="onTextareaBlur($event)"
      (keydown)="onTextareaKeyDown($event)">
    </textarea>


    <!-- Ícone de sufixo customizado -->
    @if (metadata()?.suffixIcon) {
      <mat-icon 
        matSuffix
        [matTooltip]="'Icon: ' + metadata()?.suffixIcon"
        matTooltipPosition="above">
        {{ metadata()?.suffixIcon }}
      </mat-icon>
    }

    <!-- Texto de ajuda -->
    @if (metadata()?.hint) {
      <mat-hint 
        [id]="componentId() + '-hint'"
        align="start">
        {{ metadata()?.hint }}
      </mat-hint>
    }

    <!-- Contador de caracteres -->
    @if (shouldShowCharacterCount()) {
      <mat-hint 
        align="end"
        class="pdx-character-count"
        [class.pdx-character-count-warning]="textareaState().characterCount > (metadata()?.maxLength! * 0.8)"
        [class.pdx-character-count-error]="textareaState().characterCount >= metadata()?.maxLength!">
        {{ textareaState().characterCount }}{{ metadata()?.maxLength ? '/' + metadata()?.maxLength : '' }}
      </mat-hint>
    }

    <!-- Mensagens de erro -->
    @if (hasValidationError()) {
      <mat-error 
        [id]="componentId() + '-error'"
        class="pdx-error-message">
        <mat-icon class="pdx-error-icon">error_outline</mat-icon>
        {{ primaryErrorMessage() }}
      </mat-error>
    }

    <!-- Erros adicionais (se houver múltiplos) -->
    @if (allErrorMessages().length > 1) {
      <div class="pdx-additional-errors">
        @for (error of allErrorMessages().slice(1); track error) {
          <mat-error class="pdx-error-message pdx-additional-error">
            {{ error }}
          </mat-error>
        }
      </div>
    }

  </mat-form-field>

</div>



<!-- Loading indicator para validação assíncrona -->
@if (validationState().isValidating) {
  <div class="pdx-validation-loading" [attr.aria-label]="'Validating ' + metadata()?.label">
    <mat-icon class="pdx-loading-spinner">hourglass_empty</mat-icon>
    <span class="pdx-sr-only">Validating...</span>
  </div>
}

<!-- Indicador de estado enterprise (debug) -->
@if (isDebugMode() && metadata()?.security) {
  <div class="pdx-debug-info">
    <small class="pdx-debug-security">
      Security Level: {{ metadata()?.security?.securityLevel }}
@if (metadata()?.security?.audit?.enabled) {
        | Audit: ON
      }
      | Chars: {{ textareaState().characterCount }}
    </small>
  </div>
}